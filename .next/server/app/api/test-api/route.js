"use strict";(()=>{var e={};e.id=943,e.ids=[943],e.modules={8013:e=>{e.exports=require("mongodb")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},7533:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>h,patchFetch:()=>y,requestAsyncStorage:()=>p,routeModule:()=>f,serverHooks:()=>_,staticGenerationAsyncStorage:()=>g});var s={};a.r(s),a.d(s,{GET:()=>d,POST:()=>u});var i=a(9303),n=a(8716),r=a(670),o=a(7070),c=a(2021),l=a(7793);async function d(e){try{console.log("Testing Private API connection...");let e="unknown",t=null;try{e=(await l.X7.Conversions.list({per_page:1})).data?"connected":"no data",console.log("✅ Private API connected successfully")}catch(a){e="error",t=a.message,console.error("❌ Private API error:",a.message)}let{db:a}=await (0,c.vO)(),s=(0,c.g)(a),i=(await s.aggregate([{$facet:{total:[{$count:"count"}],byGoalType:[{$group:{_id:"$goal_type",count:{$sum:1}}}],byStatus:[{$group:{_id:"$status",count:{$sum:1}}}],testCount:[{$match:{is_test:!0}},{$count:"count"}]}}]).toArray())[0],n=await s.find({is_test:!0}).sort({createdAt:-1}).limit(20).toArray();return o.NextResponse.json({success:!0,test:{apiConnection:{status:e,error:t},database:{totalConversions:i.total[0]?.count||0,testLeadsCount:i.testCount[0]?.count||0,byGoalType:i.byGoalType.reduce((e,t)=>(e[t._id]=t.count,e),{}),byStatus:i.byStatus.reduce((e,t)=>(e[t._id]=t.count,e),{})},recentTestLeads:n.map(e=>({id:e._id?.toString(),click_id:e.click_id,goal_type:e.goal_type,amount:e.amount,status:e.status,createdAt:e.createdAt,user_agent:e.user_agent?.substring(0,50)+"...",country:e.country}))}})}catch(e){return console.error("Test API error:",e),o.NextResponse.json({success:!1,message:e.message||"Internal server error"},{status:500})}}async function u(e){try{let{db:t}=await (0,c.vO)(),a=(0,c.g)(t),{click_id:s="test_"+Date.now(),goal_type:i="registration",amount:n=0,is_test:r=!0}=await e.json(),d="registration"===i?l.IQ.REGISTRATION.toString():l.IQ.DEPOSIT.toString(),u={click_id:s,affiliate_id:"test_affiliate",goal_id:d,goal_type:i,offer_id:"1",amount:n,sale_amount:void 0,status:"pending",user_agent:"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/128.0.0.0 Safari/537.36 (Test Lead)",ip_address:"192.168.1.100",country:"US",region:"CA",source:"test_api",platform:"desktop",browser:"Chrome",os:"Windows",os_version:"10",device_type:"desktop",is_test:r,createdAt:new Date},f=await a.findOneAndUpdate({click_id:s,goal_id:d},{$setOnInsert:u},{upsert:!1,returnDocument:"before"});if(f)return o.NextResponse.json({success:!0,message:"Test conversion already exists",data:{id:f._id?.toString(),click_id:f.click_id,goal_type:f.goal_type},isDuplicate:!0});let p=await a.insertOne(u);return console.log("✅ Test conversion created:",p.insertedId),o.NextResponse.json({success:!0,message:"Test conversion created successfully",data:{id:p.insertedId.toString(),click_id:s,goal_type:i,is_test:r},isDuplicate:!1})}catch(e){return console.error("Create test conversion error:",e),o.NextResponse.json({success:!1,message:e.message||"Internal server error"},{status:500})}}let f=new i.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/test-api/route",pathname:"/api/test-api",filename:"route",bundlePath:"app/api/test-api/route"},resolvedPagePath:"C:\\Users\\USER\\Desktop\\BarracudaMareting\\app\\api\\test-api\\route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:p,staticGenerationAsyncStorage:g,serverHooks:_}=f,h="/api/test-api/route";function y(){return(0,r.patchFetch)({serverHooks:_,staticGenerationAsyncStorage:g})}},2021:(e,t,a)=>{a.d(t,{BF:()=>u,CL:()=>d,MU:()=>f,ac:()=>p,g:()=>g,vO:()=>c});var s=a(8013);let i=null,n=null,r=process.env.MONGODB_URI||"mongodb://127.0.0.1:27017",o=process.env.DB_NAME||"barracuda";async function c(){if(i&&n)return{client:i,db:n};try{return i=new s.MongoClient(r),await i.connect(),n=i.db(o),console.log("✅ Connected to MongoDB"),await l(n),{client:i,db:n}}catch(e){throw console.error("❌ MongoDB connection error:",e),e}}async function l(e){let t=e.collection("contacts");await t.createIndex({email:1}),await t.createIndex({type:1}),await t.createIndex({status:1}),await t.createIndex({affiliate_id:1}),await t.createIndex({createdAt:-1}),await t.createIndex({sub1:1});let a=e.collection("postbacks");await a.createIndex({click_id:1,goal:1},{unique:!0}),await a.createIndex({affiliate_id:1}),await a.createIndex({createdAt:-1});let s=e.collection("ftds");await s.createIndex({click_id:1},{unique:!0}),await s.createIndex({affiliate_id:1}),await s.createIndex({createdAt:-1});let i=e.collection("admins");await i.createIndex({email:1},{unique:!0});let n=e.collection("conversions");await n.createIndex({click_id:1,goal_id:1},{unique:!0}),await n.createIndex({affiliate_id:1}),await n.createIndex({goal_type:1}),await n.createIndex({createdAt:-1}),console.log("✅ Database indexes created")}function d(e){return e.collection("contacts")}function u(e){return e.collection("postbacks")}function f(e){return e.collection("ftds")}function p(e){return e.collection("admins")}function g(e){return e.collection("conversions")}},7793:(e,t,a)=>{a.d(t,{IQ:()=>n,X7:()=>l});let s=process.env.PRIVATE_API_BASE_URL||"https://hooplaseft.com/backend/open-api/v1",i=process.env.PRIVATE_API_TOKEN||"49c6fbc5d8f07187e6d312cb1d754db354bdc5937f76f5cd2af09ac8a3880d6d",n={REGISTRATION:5,DEPOSIT:6};async function r(e,t={}){let a=`${s}${e}`,n={headers:{Authorization:`Bearer ${i}`,"Content-Type":"application/json",...t.headers||{}},...t};try{let e=await fetch(a,n),t=await e.json();if(!e.ok)throw Error(t.message||`API request failed: ${e.status}`);return t}catch(e){throw console.error("Private API error:",e),e}}let o={async list(e={}){let t=new URLSearchParams;return e.affiliate_id&&t.append("affiliate_id",e.affiliate_id.toString()),e.offer_id&&t.append("offer_id",e.offer_id.toString()),e.goal_type_id&&t.append("goal_type_id",e.goal_type_id.toString()),e.hash&&t.append("hash",Array.isArray(e.hash)?e.hash.join(","):e.hash),e.created_at_from&&t.append("created_at_from",e.created_at_from),e.created_at_to&&t.append("created_at_to",e.created_at_to),e.afm_date_from&&t.append("afm_date_from",e.afm_date_from),e.afm_date_to&&t.append("afm_date_to",e.afm_date_to),e.page&&t.append("page",e.page.toString()),e.per_page&&t.append("per_page",e.per_page.toString()),r(`/users/conversions?${t.toString()}`)},get:async e=>r(`/users/conversions/${e}`),async create(e){if(e.length>100)throw Error("Maximum 100 conversions per request");return r("/users/conversions",{method:"POST",body:JSON.stringify({conversions:e})})},async createOne(e){let t=await this.create([e]);return t.conversions?.[0]},update:async e=>r("/users/conversions_update",{method:"POST",body:JSON.stringify({conversions:e})})};async function c(e){let t=await o.list({hash:e.clickHash,goal_type_id:e.goalTypeId,per_page:1});return t.data&&t.data.length>0?(console.log("Conversion already exists for hash:",e.clickHash),{success:!0,conversion:t.data[0],isDuplicate:!0}):{success:!0,conversion:await o.createOne({hash:e.clickHash,goal_type_id:e.goalTypeId,unique:e.unique||"API",deposit_amount:e.depositAmount,sale_amount:e.saleAmount,is_test:e.isTest}),isDuplicate:!1}}let l={Conversions:o,Clicks:{async list(e={}){let t=new URLSearchParams;return e.affiliate_id&&t.append("affiliate_id",e.affiliate_id.toString()),e.offer_id&&t.append("offer_id",e.offer_id.toString()),e.page&&t.append("page",e.page.toString()),e.per_page&&t.append("per_page",e.per_page.toString()),r(`/affiliates/clicks?${t.toString()}`)},async get(e){try{let t=await this.list({per_page:200,page:1});if(t.data)return t.data.find(t=>t.id===e)||null}catch(e){console.warn("⚠️ ClicksAPI.list() failed, clicks endpoint may not be accessible")}return null},async getHashByClickId(e){try{let t=await this.get(e);if(t&&t.hash)return console.log(`✅ Found hash for click ${e}: ${t.hash}`),t.hash;return console.warn(`⚠️ No hash found for click ${e}`),null}catch(t){return console.warn(`⚠️ ClicksAPI.getHashByClickId() failed for click ${e}:`,t.message),null}},async findHashFromConversions(e,t){try{let a=e.collection("conversions"),s=await a.findOne({click_id:t});if(s&&s.click_hash)return console.log(`✅ Found hash from existing conversion: ${s.click_hash}`),s.click_hash;let i=e.collection("postbacks"),n=await i.findOne({click_id:t});if(n&&n.click_hash)return console.log(`✅ Found hash from existing postback: ${n.click_hash}`),n.click_hash;return null}catch(e){return console.warn("⚠️ Failed to find hash from conversions:",e.message),null}}},Goals:{list:async(e,t)=>r(t?`/users/offers/${e}/goals/${t}`:`/users/offers/${e}/goals`),create:async(e,t)=>r(`/users/offers/${e}/goals`,{method:"POST",body:JSON.stringify(t)}),update:async(e,t,a)=>r(`/users/offers/${e}/goals/${t}`,{method:"PUT",body:JSON.stringify(a)})},RiskManagement:{getAffiliateRisks:async e=>r(`/users/affiliates/${e}/risks`),createAffiliateRisk:async(e,t)=>r(`/users/affiliates/${e}/risks`,{method:"POST",body:JSON.stringify(t)}),getOfferRisks:async e=>r(`/users/offers/${e}/risks`),createOfferRisk:async(e,t)=>r(`/users/offers/${e}/risks`,{method:"POST",body:JSON.stringify(t)})},Qualifications:{getAffiliateQualifications:async e=>r(`/users/affiliates/${e}/qualifications`),createAffiliateQualification:async(e,t)=>r(`/users/affiliates/${e}/qualifications`,{method:"POST",body:JSON.stringify(t)}),getOfferQualifications:async e=>r(`/users/offers/${e}/qualifications`),createOfferQualification:async(e,t)=>r(`/users/offers/${e}/qualifications`,{method:"POST",body:JSON.stringify(t)})},createAffiliateConversion:c,GOAL_TYPES:n}}};var t=require("../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),s=t.X(0,[276,972],()=>a(7533));module.exports=s})();