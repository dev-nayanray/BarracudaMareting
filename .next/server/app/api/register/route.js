"use strict";(()=>{var e={};e.id=569,e.ids=[569],e.modules={8013:e=>{e.exports=require("mongodb")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},7627:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>_,patchFetch:()=>w,requestAsyncStorage:()=>f,routeModule:()=>p,serverHooks:()=>m,staticGenerationAsyncStorage:()=>g});var i={};a.r(i),a.d(i,{POST:()=>u});var s=a(9303),o=a(8716),n=a(670),r=a(7070),d=a(2021);let c={baseUrl:"https://hooplaseft.com/api/v3",goalRegistration:"5",goalDeposit:"6",defaultHash:process.env.HOOPLASEFT_HASH||"eb20d583f46d5dc303e251607e04d240"};async function l(e,t,a,i,s={}){try{let o=new URLSearchParams({hash:i,click_id:t,affiliate_id:a,...s}),n=`${c.baseUrl}/goal/${e}?${o.toString()}`;console.log(`ðŸŽ¯ Sending Hooplaseft Goal #${e} postback:`,n);let r=await fetch(n,{method:"GET",headers:{"User-Agent":"Next.js Affiliate API",Accept:"application/json"}}),d=await r.text();return console.log(`âœ… Hooplaseft Goal #${e} response:`,d.substring(0,200)),{success:r.ok,message:d}}catch(t){return console.error(`âŒ Hooplaseft Goal #${e} error:`,t.message),{success:!1,message:t.message}}}async function u(e){try{let{db:t}=await (0,d.vO)(),a=(0,d.CL)(t),i=(0,d.BF)(t),s=(0,d.g)(t),{name:o,email:n,company:u,type:p,messenger:f,username:g,message:m,affiliate_id:_,url_id:w,sub1:b,sub2:v,sub3:A,campaignId:h,trackingSource:x,deposit_amount:R,sale_amount:k}=await e.json();if(!o||!n||!u||!p)return r.NextResponse.json({success:!1,message:"Name, email, company, and type are required."},{status:400});if(await a.findOne({email:n}))return r.NextResponse.json({success:!1,message:"This email has already been registered."},{status:409});let I={name:o,email:n,company:u,type:p,messenger:f||void 0,username:g||void 0,message:m||void 0,affiliate_id:_||void 0,url_id:w||void 0,sub1:b||void 0,sub2:v||void 0,sub3:A||void 0,campaign_id:h||void 0,tracking_source:x||"contact_form",status:"new",affiliate_status:"affiliate"===p?"pending":void 0,affiliateRegistered:!1,affiliateError:void 0,ftd:!1,createdAt:new Date,updatedAt:new Date},$=await a.findOneAndUpdate({email:n},{$setOnInsert:I},{upsert:!0,returnDocument:"after"});if(!($?.createdAt&&$.createdAt>=new Date(Date.now()-1e3)))return r.NextResponse.json({success:!1,message:"This email has already been registered."},{status:409});if(console.log("âœ… Contact saved to MongoDB:",$?._id),"affiliate"===p){let e=`${c.baseUrl}/offer/2?affiliate_id=${_||"2"}&url_id=${w||"2"}&source=${x||"contact_form"}&name=${encodeURIComponent(o)}&email=${encodeURIComponent(n)}&company=${encodeURIComponent(u)}&unique=1`;return console.log(`ðŸŽ¯ Tracking URL: ${e}`),fetch(e,{method:"GET",headers:{"User-Agent":"Next.js Affiliate API",Accept:"application/json"},redirect:"follow"}).then(async e=>{let t=e.url;console.log(`ðŸŽ¯ Redirect URL: ${t}`);let r=new URL(t),d=r.searchParams.get("sub1")||r.searchParams.get("click_id");if(!d){console.log("âš ï¸ No sub1 or click_id found in redirect URL");return}console.log(`âœ… Captured sub1: ${d}`),await a.updateOne({_id:$?._id},{$set:{sub1:d,clicked_url:t,updatedAt:new Date}}),console.log(`ðŸŽ¯ Sending Registration Postback (Goal #5) with sub1: ${d}`);let p=await l(c.goalRegistration,d,_||"2",d,{sub1:d,sub2:v||"",sub3:A||"",goal_type:"registration",name:encodeURIComponent(o),email:encodeURIComponent(n),company:encodeURIComponent(u)});if(console.log(`âœ… Registration postback success: ${p.success}`),await s.findOneAndUpdate({click_id:d,goal_id:c.goalRegistration},{$setOnInsert:{click_id:d,affiliate_id:_||"2",goal_id:c.goalRegistration,goal_type:"registration",offer_id:"2",amount:0,sale_amount:void 0,status:p.success?"approved":"pending",sub1:d,sub2:v||void 0,sub3:A||void 0,metadata:{name:o,email:n,company:u,deposit_amount:R||void 0},createdAt:new Date},$set:{updatedAt:new Date}},{upsert:!0}),p.success){await a.updateOne({_id:$?._id},{$set:{affiliateRegistered:!0,affiliateError:void 0,updatedAt:new Date}});let e=R||100;await a.updateOne({_id:$?._id},{$set:{ftd:!0,ftd_date:new Date,ftd_amount:e,updatedAt:new Date}}),console.log(`ðŸŽ¯ Sending Deposit Postback (Goal #6) with sub1: ${d}`);let t=await l(c.goalDeposit,d,_||"2",d,{sub1:d,sub2:v||"",sub3:A||"",goal_type:"deposit",deposit_amount:e.toString(),sale_amount:k?.toString()||e.toString()});console.log(`âœ… Deposit postback success: ${t.success}`),await s.findOneAndUpdate({click_id:d,goal_id:c.goalDeposit},{$setOnInsert:{click_id:d,affiliate_id:_||"2",goal_id:c.goalDeposit,goal_type:"deposit",offer_id:"2",amount:e,sale_amount:k||e,status:t.success?"approved":"pending",sub1:d,sub2:v||void 0,sub3:A||void 0,metadata:{name:o,email:n,company:u},createdAt:new Date},$set:{updatedAt:new Date}},{upsert:!0}),await i.findOneAndUpdate({click_id:d,goal:"registration"},{$setOnInsert:{click_id:d,affiliate_id:_||"2",offer_id:void 0,goal:"registration",amount:void 0,sale_amount:void 0,status:"pending",sub1:d,sub2:v||void 0,sub3:A||void 0,createdAt:new Date},$set:{updatedAt:new Date}},{upsert:!0}),await i.findOneAndUpdate({click_id:d,goal:"deposit"},{$setOnInsert:{click_id:d,affiliate_id:_||"2",offer_id:void 0,goal:"deposit",amount:e,sale_amount:k||e,status:t.success?"approved":"pending",sub1:d,sub2:v||void 0,sub3:A||void 0,createdAt:new Date},$set:{updatedAt:new Date}},{upsert:!0}),console.log("âœ… All postbacks completed successfully")}else await a.updateOne({_id:$?._id},{$set:{affiliateError:p.message,updatedAt:new Date}})}).catch(async e=>{console.error("âŒ Tracking URL fetch error:",e.message),await a.updateOne({_id:$?._id},{$set:{affiliateError:"Tracking URL fetch failed: "+e.message,updatedAt:new Date}})}),r.NextResponse.json({success:!0,message:"Affiliate registration submitted successfully.",data:{affiliatePosted:!0,isAffiliate:!0,trackingLink:e,affiliateId:_||"2",dashboardUrl:"https://barracuda-pp.irev.com/affiliates/en/app/dashboard",note:"Your application is under review. You will receive iREV dashboard access within 24 hours via email."}})}return r.NextResponse.json({success:!0,message:"Registration successful. Our team will contact you within 24 hours.",data:{isAffiliate:!1,posted:!0}})}catch(e){return console.error("Register API error:",e),r.NextResponse.json({success:!1,message:e.message||"Internal server error",data:{affiliateError:!0}},{status:500})}}let p=new s.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/register/route",pathname:"/api/register",filename:"route",bundlePath:"app/api/register/route"},resolvedPagePath:"C:\\Users\\USER\\Desktop\\BarracudaMareting\\app\\api\\register\\route.ts",nextConfigOutput:"",userland:i}),{requestAsyncStorage:f,staticGenerationAsyncStorage:g,serverHooks:m}=p,_="/api/register/route";function w(){return(0,n.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:g})}},2021:(e,t,a)=>{a.d(t,{BF:()=>u,CL:()=>l,MU:()=>p,ac:()=>f,g:()=>g,vO:()=>d});var i=a(8013);let s=null,o=null,n=process.env.MONGODB_URI||"mongodb://127.0.0.1:27017",r=process.env.DB_NAME||"barracuda";async function d(){if(s&&o)return{client:s,db:o};try{return s=new i.MongoClient(n),await s.connect(),o=s.db(r),console.log("âœ… Connected to MongoDB"),await c(o),{client:s,db:o}}catch(e){throw console.error("âŒ MongoDB connection error:",e),e}}async function c(e){let t=e.collection("contacts");await t.createIndex({email:1}),await t.createIndex({type:1}),await t.createIndex({status:1}),await t.createIndex({affiliate_id:1}),await t.createIndex({createdAt:-1}),await t.createIndex({sub1:1});let a=e.collection("postbacks");await a.createIndex({click_id:1,goal:1},{unique:!0}),await a.createIndex({affiliate_id:1}),await a.createIndex({createdAt:-1});let i=e.collection("ftds");await i.createIndex({click_id:1},{unique:!0}),await i.createIndex({affiliate_id:1}),await i.createIndex({createdAt:-1});let s=e.collection("admins");await s.createIndex({email:1},{unique:!0});let o=e.collection("conversions");await o.createIndex({click_id:1,goal_id:1},{unique:!0}),await o.createIndex({affiliate_id:1}),await o.createIndex({goal_type:1}),await o.createIndex({createdAt:-1}),console.log("âœ… Database indexes created")}function l(e){return e.collection("contacts")}function u(e){return e.collection("postbacks")}function p(e){return e.collection("ftds")}function f(e){return e.collection("admins")}function g(e){return e.collection("conversions")}}};var t=require("../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),i=t.X(0,[276,972],()=>a(7627));module.exports=i})();