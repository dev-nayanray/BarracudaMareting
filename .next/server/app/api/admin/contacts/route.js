"use strict";(()=>{var t={};t.id=984,t.ids=[984],t.modules={8013:t=>{t.exports=require("mongodb")},399:t=>{t.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:t=>{t.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},3607:(t,e,a)=>{a.r(e),a.d(e,{originalPathname:()=>g,patchFetch:()=>$,requestAsyncStorage:()=>p,routeModule:()=>l,serverHooks:()=>f,staticGenerationAsyncStorage:()=>m});var n={};a.r(n),a.d(n,{GET:()=>u,POST:()=>d});var o=a(9303),r=a(8716),i=a(670),c=a(7070),s=a(2021);async function u(t){try{let{db:e}=await (0,s.vO)(),a=(0,s.CL)(e),{searchParams:n}=new URL(t.url),o=parseInt(n.get("page")||"1"),r=parseInt(n.get("limit")||"50"),i=n.get("type"),u=n.get("status"),d=n.get("search"),l=n.get("sortBy")||"createdAt",p="asc"===n.get("sortOrder")?1:-1,m={};i&&(m.type=i),u&&(m.status=u),d&&(m.$or=[{name:{$regex:d,$options:"i"}},{email:{$regex:d,$options:"i"}},{company:{$regex:d,$options:"i"}}]);let f=(o-1)*r,g=await a.countDocuments(m),$=await a.find(m).sort({[l]:p}).skip(f).limit(r).toArray(),x=(await a.aggregate([{$facet:{total:[{$count:"count"}],byType:[{$group:{_id:"$type",count:{$sum:1}}}],byStatus:[{$group:{_id:"$status",count:{$sum:1}}}],affiliateStats:[{$match:{type:"affiliate"}},{$group:{_id:"$affiliate_status",count:{$sum:1}}}],thisMonth:[{$match:{createdAt:{$gte:new Date(new Date().getFullYear(),new Date().getMonth(),1)}}},{$count:"count"}],ftdStats:[{$match:{ftd:!0}},{$count:"count"}],ftdAmountSum:[{$match:{ftd:!0,ftd_amount:{$exists:!0}}},{$group:{_id:null,total:{$sum:"$ftd_amount"}}}]}}]).toArray())[0],w=x.ftdStats?.[0]?.count||0,y=x.ftdAmountSum?.[0]?.total||0;return c.NextResponse.json({success:!0,data:$.map(t=>({...t,id:t._id?.toString(),_id:void 0})),stats:{total:x.total[0]?.count||0,byType:x.byType.reduce((t,e)=>(t[e._id]=e.count,t),{}),byStatus:x.byStatus.reduce((t,e)=>(t[e._id]=e.count,t),{}),affiliateStats:x.affiliateStats.reduce((t,e)=>(t[e._id]=e.count,t),{}),thisMonth:x.thisMonth[0]?.count||0,ftdCount:w,totalFtdAmount:y},pagination:{page:o,limit:r,total:g,totalPages:Math.ceil(g/r)}})}catch(t){return console.error("Get contacts error:",t),c.NextResponse.json({success:!1,message:"Internal server error"},{status:500})}}async function d(t){try{let{db:e}=await (0,s.vO)(),a=(0,s.CL)(e),{type:n,status:o,search:r}=await t.json(),i={};n&&(i.type=n),o&&(i.status=o),r&&(i.$or=[{name:{$regex:r,$options:"i"}},{email:{$regex:r,$options:"i"}}]);let u=await a.find(i).sort({createdAt:-1}).toArray(),d=["Name,Email,Company,Type,Status,Messenger,Username,Affiliate ID,Sub1,Traffic Source,Campaign ID,FTD,FTD Amount,FTD Date,Created At"];for(let t of u){let e=[`"${t.name||""}"`,`"${t.email||""}"`,`"${t.company||""}"`,`"${t.type||""}"`,`"${t.status||""}"`,`"${t.messenger||""}"`,`"${t.username||""}"`,`"${t.affiliate_id||""}"`,`"${t.sub1||""}"`,`"${t.tracking_source||""}"`,`"${t.campaign_id||""}"`,t.ftd?"Yes":"No",t.ftd_amount||"",t.ftd_date?new Date(t.ftd_date).toISOString():"",t.createdAt?new Date(t.createdAt).toISOString():""];d.push(e.join(","))}return new c.NextResponse(d.join("\n"),{headers:{"Content-Type":"text/csv","Content-Disposition":`attachment; filename="contacts-${new Date().toISOString().split("T")[0]}.csv"`}})}catch(t){return console.error("Export contacts error:",t),c.NextResponse.json({success:!1,message:"Internal server error"},{status:500})}}let l=new o.AppRouteRouteModule({definition:{kind:r.x.APP_ROUTE,page:"/api/admin/contacts/route",pathname:"/api/admin/contacts",filename:"route",bundlePath:"app/api/admin/contacts/route"},resolvedPagePath:"C:\\Users\\USER\\Desktop\\BarracudaMareting\\app\\api\\admin\\contacts\\route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:p,staticGenerationAsyncStorage:m,serverHooks:f}=l,g="/api/admin/contacts/route";function $(){return(0,i.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:m})}},2021:(t,e,a)=>{a.d(e,{BF:()=>l,CL:()=>d,MU:()=>p,ac:()=>m,g:()=>f,vO:()=>s});var n=a(8013);let o=null,r=null,i=process.env.MONGODB_URI||"mongodb://127.0.0.1:27017",c=process.env.DB_NAME||"barracuda";async function s(){if(o&&r)return{client:o,db:r};try{return o=new n.MongoClient(i),await o.connect(),r=o.db(c),console.log("✅ Connected to MongoDB"),await u(r),{client:o,db:r}}catch(t){throw console.error("❌ MongoDB connection error:",t),t}}async function u(t){let e=t.collection("contacts");await e.createIndex({email:1}),await e.createIndex({type:1}),await e.createIndex({status:1}),await e.createIndex({affiliate_id:1}),await e.createIndex({createdAt:-1}),await e.createIndex({sub1:1});let a=t.collection("postbacks");await a.createIndex({click_id:1,goal:1},{unique:!0}),await a.createIndex({affiliate_id:1}),await a.createIndex({createdAt:-1});let n=t.collection("ftds");await n.createIndex({click_id:1},{unique:!0}),await n.createIndex({affiliate_id:1}),await n.createIndex({createdAt:-1});let o=t.collection("admins");await o.createIndex({email:1},{unique:!0});let r=t.collection("conversions");await r.createIndex({click_id:1,goal_id:1},{unique:!0}),await r.createIndex({affiliate_id:1}),await r.createIndex({goal_type:1}),await r.createIndex({createdAt:-1}),console.log("✅ Database indexes created")}function d(t){return t.collection("contacts")}function l(t){return t.collection("postbacks")}function p(t){return t.collection("ftds")}function m(t){return t.collection("admins")}function f(t){return t.collection("conversions")}}};var e=require("../../../../webpack-runtime.js");e.C(t);var a=t=>e(e.s=t),n=e.X(0,[276,972],()=>a(3607));module.exports=n})();