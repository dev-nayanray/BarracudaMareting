"use strict";(()=>{var t={};t.id=980,t.ids=[980],t.modules={8013:t=>{t.exports=require("mongodb")},399:t=>{t.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:t=>{t.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},4797:(t,e,a)=>{a.r(e),a.d(e,{originalPathname:()=>v,patchFetch:()=>g,requestAsyncStorage:()=>d,routeModule:()=>l,serverHooks:()=>m,staticGenerationAsyncStorage:()=>p});var o={};a.r(o),a.d(o,{GET:()=>u});var n=a(9303),r=a(8716),i=a(670),c=a(7070),s=a(2021);async function u(){try{let{db:t}=await (0,s.vO)(),e=(0,s.g)(t),a=(await e.aggregate([{$facet:{total:[{$count:"count"}],byGoalType:[{$group:{_id:"$goal_type",count:{$sum:1}}}],byStatus:[{$group:{_id:"$status",count:{$sum:1}}}],totalAmount:[{$group:{_id:null,total:{$sum:"$amount"}}}],approvedCount:[{$match:{status:"approved"}},{$count:"count"}],approvedAmount:[{$match:{status:"approved"}},{$group:{_id:null,total:{$sum:"$amount"}}}],thisMonth:[{$match:{createdAt:{$gte:new Date(new Date().getFullYear(),new Date().getMonth(),1)}}},{$count:"count"}],thisMonthAmount:[{$match:{createdAt:{$gte:new Date(new Date().getFullYear(),new Date().getMonth(),1)}}},{$group:{_id:null,total:{$sum:"$amount"}}}],byAffiliate:[{$group:{_id:"$affiliate_id",count:{$sum:1},totalAmount:{$sum:"$amount"}}},{$sort:{count:-1}},{$limit:20}],conversionRate:[{$group:{_id:null,approved:{$sum:{$cond:[{$eq:["$status","approved"]},1,0]}},total:{$sum:1}}}]}}]).toArray())[0],o=a.conversionRate[0]||{approved:0,total:0},n=o.total>0?(o.approved/o.total*100).toFixed(2):"0.00";return c.NextResponse.json({success:!0,data:{total:a.total[0]?.count||0,byGoalType:a.byGoalType.reduce((t,e)=>(t[e._id]={count:e.count,percentage:(e.count/(a.total[0]?.count||1)*100).toFixed(2)},t),{}),byStatus:a.byStatus.reduce((t,e)=>(t[e._id]=e.count,t),{}),totalRevenue:a.totalAmount[0]?.total||0,approvedConversions:a.approvedCount[0]?.count||0,approvedRevenue:a.approvedAmount[0]?.total||0,thisMonth:{count:a.thisMonth[0]?.count||0,revenue:a.thisMonthAmount[0]?.total||0},topAffiliates:a.byAffiliate.map(t=>({affiliate_id:t._id,conversions:t.count,revenue:t.totalAmount})),conversionRate:`${n}%`}})}catch(t){return console.error("Get conversion stats error:",t),c.NextResponse.json({success:!1,message:"Internal server error"},{status:500})}}let l=new n.AppRouteRouteModule({definition:{kind:r.x.APP_ROUTE,page:"/api/admin/conversions/stats/route",pathname:"/api/admin/conversions/stats",filename:"route",bundlePath:"app/api/admin/conversions/stats/route"},resolvedPagePath:"C:\\Users\\USER\\Desktop\\BarracudaMareting\\app\\api\\admin\\conversions\\stats\\route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:d,staticGenerationAsyncStorage:p,serverHooks:m}=l,v="/api/admin/conversions/stats/route";function g(){return(0,i.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:p})}},2021:(t,e,a)=>{a.d(e,{BF:()=>d,CL:()=>l,MU:()=>p,ac:()=>m,g:()=>v,vO:()=>s});var o=a(8013);let n=null,r=null,i=process.env.MONGODB_URI||"mongodb://127.0.0.1:27017",c=process.env.DB_NAME||"barracuda";async function s(){if(n&&r)return{client:n,db:r};try{return n=new o.MongoClient(i),await n.connect(),r=n.db(c),console.log("✅ Connected to MongoDB"),await u(r),{client:n,db:r}}catch(t){throw console.error("❌ MongoDB connection error:",t),t}}async function u(t){let e=t.collection("contacts");await e.createIndex({email:1}),await e.createIndex({type:1}),await e.createIndex({status:1}),await e.createIndex({affiliate_id:1}),await e.createIndex({createdAt:-1}),await e.createIndex({sub1:1});let a=t.collection("postbacks");await a.createIndex({click_id:1,goal:1},{unique:!0}),await a.createIndex({affiliate_id:1}),await a.createIndex({createdAt:-1});let o=t.collection("ftds");await o.createIndex({click_id:1},{unique:!0}),await o.createIndex({affiliate_id:1}),await o.createIndex({createdAt:-1});let n=t.collection("admins");await n.createIndex({email:1},{unique:!0});let r=t.collection("conversions");await r.createIndex({click_id:1,goal_id:1},{unique:!0}),await r.createIndex({affiliate_id:1}),await r.createIndex({goal_type:1}),await r.createIndex({createdAt:-1}),console.log("✅ Database indexes created")}function l(t){return t.collection("contacts")}function d(t){return t.collection("postbacks")}function p(t){return t.collection("ftds")}function m(t){return t.collection("admins")}function v(t){return t.collection("conversions")}}};var e=require("../../../../../webpack-runtime.js");e.C(t);var a=t=>e(e.s=t),o=e.X(0,[276,972],()=>a(4797));module.exports=o})();