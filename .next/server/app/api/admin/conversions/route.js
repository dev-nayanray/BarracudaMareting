"use strict";(()=>{var e={};e.id=368,e.ids=[368],e.modules={8013:e=>{e.exports=require("mongodb")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},3565:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>m,patchFetch:()=>f,requestAsyncStorage:()=>p,routeModule:()=>l,serverHooks:()=>g,staticGenerationAsyncStorage:()=>v});var o={};a.r(o),a.d(o,{GET:()=>d,POST:()=>u});var n=a(9303),r=a(8716),i=a(670),s=a(7070),c=a(2021);async function d(e){try{let{db:t}=await (0,c.vO)(),a=(0,c.g)(t),{searchParams:o}=new URL(e.url),n=parseInt(o.get("page")||"1"),r=parseInt(o.get("limit")||"50"),i=o.get("goal_type"),d=o.get("affiliate_id"),u=o.get("status"),l=o.get("sortBy")||"createdAt",p="asc"===o.get("sortOrder")?1:-1,v={};i&&(v.goal_type=i),d&&(v.affiliate_id=d),u&&(v.status=u);let g=(n-1)*r,m=await a.countDocuments(v),f=await a.find(v).sort({[l]:p}).skip(g).limit(r).toArray(),w=(await a.aggregate([{$facet:{total:[{$count:"count"}],byGoalType:[{$group:{_id:"$goal_type",count:{$sum:1}}}],byStatus:[{$group:{_id:"$status",count:{$sum:1}}}],totalAmount:[{$group:{_id:null,total:{$sum:"$amount"}}}],thisMonth:[{$match:{createdAt:{$gte:new Date(new Date().getFullYear(),new Date().getMonth(),1)}}},{$count:"count"}],approvedCount:[{$match:{status:"approved"}},{$count:"count"}]}}]).toArray())[0];return s.NextResponse.json({success:!0,data:f.map(e=>({...e,id:e._id?.toString(),_id:void 0})),stats:{total:w.total[0]?.count||0,byGoalType:w.byGoalType.reduce((e,t)=>(e[t._id]=t.count,e),{}),byStatus:w.byStatus.reduce((e,t)=>(e[t._id]=t.count,e),{}),totalAmount:w.totalAmount[0]?.total||0,thisMonth:w.thisMonth[0]?.count||0,approvedCount:w.approvedCount[0]?.count||0},pagination:{page:n,limit:r,total:m,totalPages:Math.ceil(m/r)}})}catch(e){return console.error("Get conversions error:",e),s.NextResponse.json({success:!1,message:"Internal server error"},{status:500})}}async function u(e){try{let{db:t}=await (0,c.vO)(),a=(0,c.g)(t),{click_id:o,affiliate_id:n,goal_id:r,goal_type:i,offer_id:d,amount:u,sale_amount:l,status:p,sub1:v,sub2:g,sub3:m,sub4:f,sub5:w,user_agent:_,ip_address:x,country:y,region:I,source:b,platform:h,browser:A,os:D,os_version:$,manufacturer:M,device_type:C,is_test:k,advertiser_id:O,offer_url_id:R,affiliate_source:q,metadata:j}=await e.json();if(!o||!n||!r||!i)return s.NextResponse.json({success:!1,message:"click_id, affiliate_id, goal_id, and goal_type are required"},{status:400});let S={click_id:o,affiliate_id:n,goal_id:r,goal_type:i,offer_id:d||void 0,amount:u||0,sale_amount:l||void 0,status:p||"pending",sub1:v||void 0,sub2:g||void 0,sub3:m||void 0,sub4:f||void 0,sub5:w||void 0,user_agent:_||void 0,ip_address:x||void 0,country:y||void 0,region:I||void 0,source:b||void 0,platform:h||void 0,browser:A||void 0,os:D||void 0,os_version:$||void 0,manufacturer:M||void 0,device_type:C||void 0,is_test:k||void 0,advertiser_id:O||void 0,offer_url_id:R||void 0,affiliate_source:q||void 0,metadata:j||void 0,updatedAt:new Date},N=await a.findOneAndUpdate({click_id:o,goal_id:r},{$setOnInsert:{...S,createdAt:new Date},$set:{...S,updatedAt:new Date}},{upsert:!0,returnDocument:"after"}),P=!!N?.createdAt&&N.createdAt>=new Date(Date.now()-1e3);return console.log(P?"✅ New conversion saved":"⚠️ Duplicate conversion updated:",N?._id),s.NextResponse.json({success:!0,message:P?"Conversion recorded successfully":"Conversion already exists, updated",data:{id:N?._id?.toString()||null,click_id:o,affiliate_id:n,goal_id:r,goal_type:i,amount:S.amount,status:S.status,isDuplicate:!P}})}catch(e){return console.error("Create conversion error:",e),s.NextResponse.json({success:!1,message:e.message||"Internal server error"},{status:500})}}let l=new n.AppRouteRouteModule({definition:{kind:r.x.APP_ROUTE,page:"/api/admin/conversions/route",pathname:"/api/admin/conversions",filename:"route",bundlePath:"app/api/admin/conversions/route"},resolvedPagePath:"C:\\Users\\USER\\Desktop\\BarracudaMareting\\app\\api\\admin\\conversions\\route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:p,staticGenerationAsyncStorage:v,serverHooks:g}=l,m="/api/admin/conversions/route";function f(){return(0,i.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:v})}},2021:(e,t,a)=>{a.d(t,{BF:()=>l,CL:()=>u,MU:()=>p,ac:()=>v,g:()=>g,vO:()=>c});var o=a(8013);let n=null,r=null,i=process.env.MONGODB_URI||"mongodb://127.0.0.1:27017",s=process.env.DB_NAME||"barracuda";async function c(){if(n&&r)return{client:n,db:r};try{return n=new o.MongoClient(i),await n.connect(),r=n.db(s),console.log("✅ Connected to MongoDB"),await d(r),{client:n,db:r}}catch(e){throw console.error("❌ MongoDB connection error:",e),e}}async function d(e){let t=e.collection("contacts");await t.createIndex({email:1}),await t.createIndex({type:1}),await t.createIndex({status:1}),await t.createIndex({affiliate_id:1}),await t.createIndex({createdAt:-1}),await t.createIndex({sub1:1});let a=e.collection("postbacks");await a.createIndex({click_id:1,goal:1},{unique:!0}),await a.createIndex({affiliate_id:1}),await a.createIndex({createdAt:-1});let o=e.collection("ftds");await o.createIndex({click_id:1},{unique:!0}),await o.createIndex({affiliate_id:1}),await o.createIndex({createdAt:-1});let n=e.collection("admins");await n.createIndex({email:1},{unique:!0});let r=e.collection("conversions");await r.createIndex({click_id:1,goal_id:1},{unique:!0}),await r.createIndex({affiliate_id:1}),await r.createIndex({goal_type:1}),await r.createIndex({createdAt:-1}),console.log("✅ Database indexes created")}function u(e){return e.collection("contacts")}function l(e){return e.collection("postbacks")}function p(e){return e.collection("ftds")}function v(e){return e.collection("admins")}function g(e){return e.collection("conversions")}}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),o=t.X(0,[276,972],()=>a(3565));module.exports=o})();