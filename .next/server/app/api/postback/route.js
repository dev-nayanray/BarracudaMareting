"use strict";(()=>{var e={};e.id=502,e.ids=[502],e.modules={8013:e=>{e.exports=require("mongodb")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6627:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>g,patchFetch:()=>w,requestAsyncStorage:()=>l,routeModule:()=>u,serverHooks:()=>f,staticGenerationAsyncStorage:()=>p});var n={};a.r(n),a.d(n,{GET:()=>d});var o=a(9303),s=a(8716),i=a(670),r=a(7070),c=a(2021);async function d(e){try{let{db:t}=await (0,c.vO)(),a=(0,c.BF)(t),n=(0,c.CL)(t),{searchParams:o}=new URL(e.url),s=o.get("click_id"),i=o.get("affiliate_id"),d=o.get("offer_id"),u=o.get("goal"),l=o.get("status")||"pending",p=parseFloat(o.get("amount")||"0"),f=parseFloat(o.get("sale_amount")||"0"),g=o.get("sub1"),w=o.get("sub2"),x=o.get("sub3");if(!s||!i||!u)return r.NextResponse.json({success:!1,message:"Missing required parameters"},{status:400});if(!["registration","deposit"].includes(u))return r.NextResponse.json({success:!1,message:"Invalid goal type"},{status:400});console.log("Affiliate postback received:",{click_id:s,affiliate_id:i,offer_id:d,goal:u,amount:p,sale_amount:f,status:l,sub1:g,sub2:w,sub3:x});let m={click_id:s,affiliate_id:i,offer_id:d||void 0,goal:u,amount:p||void 0,sale_amount:f||void 0,status:l,sub1:g||void 0,sub2:w||void 0,sub3:x||void 0,createdAt:new Date,updatedAt:new Date},v=await a.findOneAndUpdate({click_id:s,goal:u},{$setOnInsert:m,$set:{updatedAt:new Date}},{upsert:!0,returnDocument:"after"});if(!(v?.createdAt&&v.createdAt>=new Date(Date.now()-1e3)))return console.log("Duplicate postback ignored:",s,u),r.NextResponse.json({success:!0,message:"Duplicate postback ignored",isDuplicate:!0});return console.log("✅ Postback saved to MongoDB"),g&&await n.updateOne({sub1:g},{$set:{affiliateRegistered:"registration"===u,updatedAt:new Date},$setOnInsert:{ftd:"deposit"===u||void 0,ftd_date:"deposit"===u?new Date:void 0,ftd_amount:"deposit"===u?p||f:void 0}},{upsert:!0}),"deposit"===u&&i&&await n.updateMany({affiliate_id:i},{$set:{ftd:!0,ftd_amount:p||f,ftd_date:new Date,updatedAt:new Date}}),r.NextResponse.json({success:!0,message:`Postback '${u}' recorded successfully`,isDuplicate:!1})}catch(e){return console.error("Postback error:",e),r.NextResponse.json({success:!1,message:"Internal server error"},{status:500})}}let u=new o.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/postback/route",pathname:"/api/postback",filename:"route",bundlePath:"app/api/postback/route"},resolvedPagePath:"C:\\Users\\USER\\Desktop\\BarracudaMareting\\app\\api\\postback\\route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:l,staticGenerationAsyncStorage:p,serverHooks:f}=u,g="/api/postback/route";function w(){return(0,i.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:p})}},2021:(e,t,a)=>{a.d(t,{BF:()=>l,CL:()=>u,MU:()=>p,ac:()=>f,g:()=>g,vO:()=>c});var n=a(8013);let o=null,s=null,i=process.env.MONGODB_URI||"mongodb://127.0.0.1:27017",r=process.env.DB_NAME||"barracuda";async function c(){if(o&&s)return{client:o,db:s};try{return o=new n.MongoClient(i),await o.connect(),s=o.db(r),console.log("✅ Connected to MongoDB"),await d(s),{client:o,db:s}}catch(e){throw console.error("❌ MongoDB connection error:",e),e}}async function d(e){let t=e.collection("contacts");await t.createIndex({email:1}),await t.createIndex({type:1}),await t.createIndex({status:1}),await t.createIndex({affiliate_id:1}),await t.createIndex({createdAt:-1}),await t.createIndex({sub1:1});let a=e.collection("postbacks");await a.createIndex({click_id:1,goal:1},{unique:!0}),await a.createIndex({affiliate_id:1}),await a.createIndex({createdAt:-1});let n=e.collection("ftds");await n.createIndex({click_id:1},{unique:!0}),await n.createIndex({affiliate_id:1}),await n.createIndex({createdAt:-1});let o=e.collection("admins");await o.createIndex({email:1},{unique:!0});let s=e.collection("conversions");await s.createIndex({click_id:1,goal_id:1},{unique:!0}),await s.createIndex({affiliate_id:1}),await s.createIndex({goal_type:1}),await s.createIndex({createdAt:-1}),console.log("✅ Database indexes created")}function u(e){return e.collection("contacts")}function l(e){return e.collection("postbacks")}function p(e){return e.collection("ftds")}function f(e){return e.collection("admins")}function g(e){return e.collection("conversions")}}};var t=require("../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),n=t.X(0,[276,972],()=>a(6627));module.exports=n})();