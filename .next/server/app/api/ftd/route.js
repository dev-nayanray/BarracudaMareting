"use strict";(()=>{var e={};e.id=235,e.ids=[235],e.modules={8013:e=>{e.exports=require("mongodb")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},9491:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>w,patchFetch:()=>x,requestAsyncStorage:()=>l,routeModule:()=>u,serverHooks:()=>f,staticGenerationAsyncStorage:()=>p});var n={};a.r(n),a.d(n,{POST:()=>d});var o=a(9303),r=a(8716),i=a(670),s=a(7070),c=a(2021);async function d(e){try{let{db:t}=await (0,c.vO)(),a=(0,c.MU)(t),n=(0,c.CL)(t),{click_id:o,affiliate_id:r,offer_id:i,amount:d,sale_amount:u,status:l}=await e.json();if(!o||!r||!d)return s.NextResponse.json({success:!1,message:"click_id, affiliate_id and amount are required"},{status:400});let p={click_id:o,affiliate_id:r,offer_id:i||void 0,amount:"string"==typeof d?parseFloat(d):d,sale_amount:u?"string"==typeof u?parseFloat(u):u:void 0,status:l||"approved",createdAt:new Date,updatedAt:new Date},f=await a.findOneAndUpdate({click_id:o},{$setOnInsert:p,$set:{updatedAt:new Date}},{upsert:!0,returnDocument:"after"});if(!(f?.createdAt&&f.createdAt>=new Date(Date.now()-1e3)))return console.log("Duplicate FTD ignored:",o),s.NextResponse.json({success:!0,message:"Duplicate FTD ignored",data:{click_id:o,isDuplicate:!0},isDuplicate:!0});return console.log("✅ FTD saved to MongoDB:",f?._id),await n.updateMany({$or:[{sub1:o},{affiliate_id:r}]},{$set:{ftd:!0,ftd_amount:p.amount,ftd_date:new Date,updatedAt:new Date}}),s.NextResponse.json({success:!0,message:"FTD recorded successfully",data:{click_id:o,affiliate_id:r,amount:p.amount,sale_amount:p.sale_amount,status:p.status,isDuplicate:!1}})}catch(e){return console.error("FTD API error:",e),s.NextResponse.json({success:!1,message:"Internal server error"},{status:500})}}let u=new o.AppRouteRouteModule({definition:{kind:r.x.APP_ROUTE,page:"/api/ftd/route",pathname:"/api/ftd",filename:"route",bundlePath:"app/api/ftd/route"},resolvedPagePath:"C:\\Users\\USER\\Desktop\\BarracudaMareting\\app\\api\\ftd\\route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:l,staticGenerationAsyncStorage:p,serverHooks:f}=u,w="/api/ftd/route";function x(){return(0,i.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:p})}},2021:(e,t,a)=>{a.d(t,{BF:()=>l,CL:()=>u,MU:()=>p,ac:()=>f,g:()=>w,vO:()=>c});var n=a(8013);let o=null,r=null,i=process.env.MONGODB_URI||"mongodb://127.0.0.1:27017",s=process.env.DB_NAME||"barracuda";async function c(){if(o&&r)return{client:o,db:r};try{return o=new n.MongoClient(i),await o.connect(),r=o.db(s),console.log("✅ Connected to MongoDB"),await d(r),{client:o,db:r}}catch(e){throw console.error("❌ MongoDB connection error:",e),e}}async function d(e){let t=e.collection("contacts");await t.createIndex({email:1}),await t.createIndex({type:1}),await t.createIndex({status:1}),await t.createIndex({affiliate_id:1}),await t.createIndex({createdAt:-1}),await t.createIndex({sub1:1});let a=e.collection("postbacks");await a.createIndex({click_id:1,goal:1},{unique:!0}),await a.createIndex({affiliate_id:1}),await a.createIndex({createdAt:-1});let n=e.collection("ftds");await n.createIndex({click_id:1},{unique:!0}),await n.createIndex({affiliate_id:1}),await n.createIndex({createdAt:-1});let o=e.collection("admins");await o.createIndex({email:1},{unique:!0});let r=e.collection("conversions");await r.createIndex({click_id:1,goal_id:1},{unique:!0}),await r.createIndex({affiliate_id:1}),await r.createIndex({goal_type:1}),await r.createIndex({createdAt:-1}),console.log("✅ Database indexes created")}function u(e){return e.collection("contacts")}function l(e){return e.collection("postbacks")}function p(e){return e.collection("ftds")}function f(e){return e.collection("admins")}function w(e){return e.collection("conversions")}}};var t=require("../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),n=t.X(0,[276,972],()=>a(9491));module.exports=n})();