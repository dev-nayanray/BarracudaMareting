"use strict";(()=>{var e={};e.id=388,e.ids=[388],e.modules={8013:e=>{e.exports=require("mongodb")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},4667:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>h,patchFetch:()=>v,requestAsyncStorage:()=>p,routeModule:()=>f,serverHooks:()=>_,staticGenerationAsyncStorage:()=>g});var i={};a.r(i),a.d(i,{GET:()=>u,POST:()=>l});var s=a(9303),r=a(8716),o=a(670),n=a(7070),c=a(2021),d=a(7793);async function l(e){try{let{db:t}=await (0,c.vO)(),a=(0,c.g)(t),{click_hash:i,goal_type_id:s,affiliate_id:r,offer_id:o,deposit_amount:l,sale_amount:u,payout:f,revenue:p,unique:g,is_test:_,user_agent:h,ip_address:v,country:y,region:m,source:I,platform:w,browser:k,os:A,os_version:S,manufacturer:x,device_type:O,sub1:P,sub2:b,sub3:$,sub4:R,sub5:T,advertiser_id:C,offer_url_id:q,affiliate_source:N}=await e.json();if(!i)return n.NextResponse.json({success:!1,message:"click_hash is required"},{status:400});if(!s)return n.NextResponse.json({success:!1,message:"goal_type_id is required"},{status:400});let D=null,E=null;try{D=await d.X7.createAffiliateConversion({clickHash:i,goalTypeId:s,affiliateId:r,offerId:o,depositAmount:l,saleAmount:u,unique:g,isTest:_})}catch(e){console.error("Private API conversion error:",e.message),E=e.message}let j={click_id:i,click_hash:i,affiliate_id:r?.toString()||"",goal_id:s.toString(),goal_type:s===d.IQ.REGISTRATION?"registration":s===d.IQ.DEPOSIT?"deposit":"other",offer_id:o?.toString()||"2",amount:l||0,sale_amount:u||l||void 0,status:D?.success?"approved":"pending",sub1:P||void 0,sub2:b||void 0,sub3:$||void 0,sub4:R||void 0,sub5:T||void 0,user_agent:h||void 0,ip_address:v||void 0,country:y||void 0,region:m||void 0,source:I||void 0,platform:w||void 0,browser:k||void 0,os:A||void 0,os_version:S||void 0,manufacturer:x||void 0,device_type:O||void 0,is_test:_||void 0,advertiser_id:C?.toString()||void 0,offer_url_id:q?.toString()||void 0,affiliate_source:N||void 0,metadata:{privateApiConversion:D?.conversion||null,apiError:E},updatedAt:new Date},M=await a.findOneAndUpdate({click_id:i,goal_id:s.toString()},{$setOnInsert:{...j,createdAt:new Date},$set:{updatedAt:new Date}},{upsert:!0,returnDocument:"after"}),B=!!M?.createdAt&&M.createdAt<new Date(Date.now()-1e3);return console.log(B?"⚠️ Conversion already exists, updated metadata:":"✅ Conversion saved to MongoDB:",M?._id),n.NextResponse.json({success:D?.success||!1,message:B?"Conversion already exists, metadata updated":D?.success?"Conversion created successfully via Private API":"Conversion saved locally (Private API failed)",data:{id:M?._id?.toString()||null,click_hash:i,goal_type_id:s,goal_type:j.goal_type,amount:j.amount,status:j.status,privateApiConversion:D?.conversion||null,apiError:E},isDuplicate:B})}catch(e){return console.error("Create conversion error:",e),n.NextResponse.json({success:!1,message:e.message||"Internal server error"},{status:500})}}async function u(e){try{let{searchParams:t}=new URL(e.url),a={affiliate_id:t.get("affiliate_id")?parseInt(t.get("affiliate_id")):void 0,offer_id:t.get("offer_id")?parseInt(t.get("offer_id")):void 0,goal_type_id:t.get("goal_type_id")?parseInt(t.get("goal_type_id")):void 0,hash:t.get("hash")||void 0,created_at_from:t.get("created_at_from")||void 0,created_at_to:t.get("created_at_to")||void 0,page:t.get("page")?parseInt(t.get("page")):1,per_page:t.get("per_page")?parseInt(t.get("per_page")):50},i=await d.X7.Conversions.list(a);return n.NextResponse.json({success:!0,data:i.data,pagination:{total:i.total,per_page:i.per_page,page:i.page,pages:i.pages}})}catch(e){return console.error("List conversions error:",e),n.NextResponse.json({success:!1,message:e.message||"Internal server error"},{status:500})}}let f=new s.AppRouteRouteModule({definition:{kind:r.x.APP_ROUTE,page:"/api/private/conversions/route",pathname:"/api/private/conversions",filename:"route",bundlePath:"app/api/private/conversions/route"},resolvedPagePath:"C:\\Users\\USER\\Desktop\\BarracudaMareting\\app\\api\\private\\conversions\\route.ts",nextConfigOutput:"",userland:i}),{requestAsyncStorage:p,staticGenerationAsyncStorage:g,serverHooks:_}=f,h="/api/private/conversions/route";function v(){return(0,o.patchFetch)({serverHooks:_,staticGenerationAsyncStorage:g})}},2021:(e,t,a)=>{a.d(t,{BF:()=>u,CL:()=>l,MU:()=>f,ac:()=>p,g:()=>g,vO:()=>c});var i=a(8013);let s=null,r=null,o=process.env.MONGODB_URI||"mongodb://127.0.0.1:27017",n=process.env.DB_NAME||"barracuda";async function c(){if(s&&r)return{client:s,db:r};try{return s=new i.MongoClient(o),await s.connect(),r=s.db(n),console.log("✅ Connected to MongoDB"),await d(r),{client:s,db:r}}catch(e){throw console.error("❌ MongoDB connection error:",e),e}}async function d(e){let t=e.collection("contacts");await t.createIndex({email:1}),await t.createIndex({type:1}),await t.createIndex({status:1}),await t.createIndex({affiliate_id:1}),await t.createIndex({createdAt:-1}),await t.createIndex({sub1:1});let a=e.collection("postbacks");await a.createIndex({click_id:1,goal:1},{unique:!0}),await a.createIndex({affiliate_id:1}),await a.createIndex({createdAt:-1});let i=e.collection("ftds");await i.createIndex({click_id:1},{unique:!0}),await i.createIndex({affiliate_id:1}),await i.createIndex({createdAt:-1});let s=e.collection("admins");await s.createIndex({email:1},{unique:!0});let r=e.collection("conversions");await r.createIndex({click_id:1,goal_id:1},{unique:!0}),await r.createIndex({affiliate_id:1}),await r.createIndex({goal_type:1}),await r.createIndex({createdAt:-1}),console.log("✅ Database indexes created")}function l(e){return e.collection("contacts")}function u(e){return e.collection("postbacks")}function f(e){return e.collection("ftds")}function p(e){return e.collection("admins")}function g(e){return e.collection("conversions")}},7793:(e,t,a)=>{a.d(t,{IQ:()=>r,X7:()=>d});let i=process.env.PRIVATE_API_BASE_URL||"https://hooplaseft.com/backend/open-api/v1",s=process.env.PRIVATE_API_TOKEN||"49c6fbc5d8f07187e6d312cb1d754db354bdc5937f76f5cd2af09ac8a3880d6d",r={REGISTRATION:5,DEPOSIT:6};async function o(e,t={}){let a=`${i}${e}`,r={headers:{Authorization:`Bearer ${s}`,"Content-Type":"application/json",...t.headers||{}},...t};try{let e=await fetch(a,r),t=await e.json();if(!e.ok)throw Error(t.message||`API request failed: ${e.status}`);return t}catch(e){throw console.error("Private API error:",e),e}}let n={async list(e={}){let t=new URLSearchParams;return e.affiliate_id&&t.append("affiliate_id",e.affiliate_id.toString()),e.offer_id&&t.append("offer_id",e.offer_id.toString()),e.goal_type_id&&t.append("goal_type_id",e.goal_type_id.toString()),e.hash&&t.append("hash",Array.isArray(e.hash)?e.hash.join(","):e.hash),e.created_at_from&&t.append("created_at_from",e.created_at_from),e.created_at_to&&t.append("created_at_to",e.created_at_to),e.afm_date_from&&t.append("afm_date_from",e.afm_date_from),e.afm_date_to&&t.append("afm_date_to",e.afm_date_to),e.page&&t.append("page",e.page.toString()),e.per_page&&t.append("per_page",e.per_page.toString()),o(`/users/conversions?${t.toString()}`)},get:async e=>o(`/users/conversions/${e}`),async create(e){if(e.length>100)throw Error("Maximum 100 conversions per request");return o("/users/conversions",{method:"POST",body:JSON.stringify({conversions:e})})},async createOne(e){let t=await this.create([e]);return t.conversions?.[0]},update:async e=>o("/users/conversions_update",{method:"POST",body:JSON.stringify({conversions:e})})};async function c(e){let t=await n.list({hash:e.clickHash,goal_type_id:e.goalTypeId,per_page:1});return t.data&&t.data.length>0?(console.log("Conversion already exists for hash:",e.clickHash),{success:!0,conversion:t.data[0],isDuplicate:!0}):{success:!0,conversion:await n.createOne({hash:e.clickHash,goal_type_id:e.goalTypeId,unique:e.unique||"API",deposit_amount:e.depositAmount,sale_amount:e.saleAmount,is_test:e.isTest}),isDuplicate:!1}}let d={Conversions:n,Clicks:{async list(e={}){let t=new URLSearchParams;return e.affiliate_id&&t.append("affiliate_id",e.affiliate_id.toString()),e.offer_id&&t.append("offer_id",e.offer_id.toString()),e.page&&t.append("page",e.page.toString()),e.per_page&&t.append("per_page",e.per_page.toString()),o(`/affiliates/clicks?${t.toString()}`)},async get(e){try{let t=await this.list({per_page:200,page:1});if(t.data)return t.data.find(t=>t.id===e)||null}catch(e){console.warn("⚠️ ClicksAPI.list() failed, clicks endpoint may not be accessible")}return null},async getHashByClickId(e){try{let t=await this.get(e);if(t&&t.hash)return console.log(`✅ Found hash for click ${e}: ${t.hash}`),t.hash;return console.warn(`⚠️ No hash found for click ${e}`),null}catch(t){return console.warn(`⚠️ ClicksAPI.getHashByClickId() failed for click ${e}:`,t.message),null}},async findHashFromConversions(e,t){try{let a=e.collection("conversions"),i=await a.findOne({click_id:t});if(i&&i.click_hash)return console.log(`✅ Found hash from existing conversion: ${i.click_hash}`),i.click_hash;let s=e.collection("postbacks"),r=await s.findOne({click_id:t});if(r&&r.click_hash)return console.log(`✅ Found hash from existing postback: ${r.click_hash}`),r.click_hash;return null}catch(e){return console.warn("⚠️ Failed to find hash from conversions:",e.message),null}}},Goals:{list:async(e,t)=>o(t?`/users/offers/${e}/goals/${t}`:`/users/offers/${e}/goals`),create:async(e,t)=>o(`/users/offers/${e}/goals`,{method:"POST",body:JSON.stringify(t)}),update:async(e,t,a)=>o(`/users/offers/${e}/goals/${t}`,{method:"PUT",body:JSON.stringify(a)})},RiskManagement:{getAffiliateRisks:async e=>o(`/users/affiliates/${e}/risks`),createAffiliateRisk:async(e,t)=>o(`/users/affiliates/${e}/risks`,{method:"POST",body:JSON.stringify(t)}),getOfferRisks:async e=>o(`/users/offers/${e}/risks`),createOfferRisk:async(e,t)=>o(`/users/offers/${e}/risks`,{method:"POST",body:JSON.stringify(t)})},Qualifications:{getAffiliateQualifications:async e=>o(`/users/affiliates/${e}/qualifications`),createAffiliateQualification:async(e,t)=>o(`/users/affiliates/${e}/qualifications`,{method:"POST",body:JSON.stringify(t)}),getOfferQualifications:async e=>o(`/users/offers/${e}/qualifications`),createOfferQualification:async(e,t)=>o(`/users/offers/${e}/qualifications`,{method:"POST",body:JSON.stringify(t)})},createAffiliateConversion:c,GOAL_TYPES:r}}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),i=t.X(0,[276,972],()=>a(4667));module.exports=i})();