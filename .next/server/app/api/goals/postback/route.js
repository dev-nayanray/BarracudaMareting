"use strict";(()=>{var e={};e.id=209,e.ids=[209],e.modules={8013:e=>{e.exports=require("mongodb")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},8362:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>m,patchFetch:()=>w,requestAsyncStorage:()=>f,routeModule:()=>g,serverHooks:()=>_,staticGenerationAsyncStorage:()=>v});var s={};a.r(s),a.d(s,{GET:()=>p,POST:()=>l});var o=a(9303),i=a(8716),n=a(670),r=a(7070),c=a(2021);let d={baseUrl:"https://hooplaseft.com/api/v3",goalRegistration:"5",goalDeposit:"6",hash:process.env.HOOPLASEFT_HASH||"eb20d583f46d5dc303e251607e04d240"};async function u(e,t,a,s={}){try{let o=new URLSearchParams({hash:d.hash,click_id:t,affiliate_id:a,...s}),i=`${d.baseUrl}/goal/${e}?${o.toString()}`;console.log(`ðŸŽ¯ Sending Hooplaseft Goal #${e} postback:`,i);let n=await fetch(i,{method:"GET",headers:{"User-Agent":"Next.js Affiliate API",Accept:"application/json"}}),r=await n.text();return console.log(`âœ… Hooplaseft Goal #${e} response:`,r.substring(0,200)),{success:n.ok,message:r,statusCode:n.status}}catch(t){return console.error(`âŒ Hooplaseft Goal #${e} error:`,t.message),{success:!1,message:t.message,statusCode:500}}}async function l(e){try{let{db:t}=await (0,c.vO)(),a=(0,c.g)(t),s=(0,c.CL)(t),{click_id:o,affiliate_id:i,goal_type:n,offer_id:l,amount:p,sale_amount:g,sub1:f,sub2:v,sub3:_,sub4:m,sub5:w,deposit_amount:b,user_agent:x,ip_address:h,country:k,region:A,source:R,platform:D,browser:I,os:U,os_version:y,manufacturer:S,device_type:$,is_test:O,advertiser_id:H,offer_url_id:C,affiliate_source:X,metadata:j}=await e.json();if(!o||!i)return r.NextResponse.json({success:!1,message:"click_id and affiliate_id are required"},{status:400});if(!n||!["registration","deposit"].includes(n))return r.NextResponse.json({success:!1,message:'goal_type must be "registration" or "deposit"'},{status:400});let G="registration"===n?d.goalRegistration:d.goalDeposit,M={sub1:f||"",sub2:v||"",sub3:_||"",goal_type:n,...b&&{deposit_amount:b.toString()},...p&&{amount:p.toString()},...g&&{sale_amount:g.toString()}},P=await u(G,o,i,M),q={click_id:o,affiliate_id:i,goal_id:G,goal_type:n,offer_id:l||"2",amount:p||b||0,sale_amount:g||p||b||void 0,status:P.success?"approved":"pending",sub1:f||void 0,sub2:v||void 0,sub3:_||void 0,sub4:m||void 0,sub5:w||void 0,user_agent:x||void 0,ip_address:h||void 0,country:k||void 0,region:A||void 0,source:R||void 0,platform:D||void 0,browser:I||void 0,os:U||void 0,os_version:y||void 0,manufacturer:S||void 0,device_type:$||void 0,is_test:O||void 0,advertiser_id:H||void 0,offer_url_id:C||void 0,affiliate_source:X||void 0,metadata:j?{...j,postbackResponse:P.message}:{postbackResponse:P.message},updatedAt:new Date},N=await a.findOneAndUpdate({click_id:o,goal_id:G},{$setOnInsert:{...q,createdAt:new Date},$set:{...q,updatedAt:new Date}},{upsert:!0,returnDocument:"after"}),E=!!N?.createdAt&&N.createdAt>=new Date(Date.now()-1e3);if(console.log(E?"âœ… New conversion saved to MongoDB":"âš ï¸ Duplicate conversion updated:",N?._id),f){let e={updatedAt:new Date};"registration"===n?e.affiliateRegistered=P.success:"deposit"===n&&(e.ftd=P.success,P.success&&(e.ftd_date=new Date,e.ftd_amount=p||b||0)),await s.updateOne({sub1:f},{$set:e},{upsert:!0}),console.log("âœ… Associated contact updated")}return i&&"deposit"===n&&(await s.updateMany({affiliate_id:i},{$set:{ftd:P.success,ftd_date:P.success?new Date:void 0,ftd_amount:P.success?p||b||0:void 0,updatedAt:new Date}}),console.log("âœ… Contacts updated by affiliate_id")),r.NextResponse.json({success:P.success,message:P.success?`Goal "${n}" postback sent successfully`:`Goal "${n}" postback failed`,data:{id:N?._id?.toString()||null,click_id:o,affiliate_id:i,goal_id:G,goal_type:n,amount:q.amount,status:q.status,postbackResponse:P.message,postbackStatusCode:P.statusCode,isDuplicate:!E}},{status:P.success?200:P.statusCode})}catch(e){return console.error("Goal postback error:",e),r.NextResponse.json({success:!1,message:e.message||"Internal server error"},{status:500})}}async function p(e){let{searchParams:t}=new URL(e.url);return"test"===(t.get("action")||"test")?r.NextResponse.json({success:!0,message:"Goals API is working",config:{baseUrl:d.baseUrl,goalRegistration:d.goalRegistration,goalDeposit:d.goalDeposit,hashSet:"YOUR_HASH_HERE"!==d.hash},usage:{registration:`${d.baseUrl}/goal/${d.goalRegistration}?hash=YOUR_HASH&click_id=XXX&affiliate_id=XXX`,deposit:`${d.baseUrl}/goal/${d.goalDeposit}?hash=YOUR_HASH&click_id=XXX&affiliate_id=XXX`}}):r.NextResponse.json({success:!1,message:"Unknown action"},{status:400})}let g=new o.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/goals/postback/route",pathname:"/api/goals/postback",filename:"route",bundlePath:"app/api/goals/postback/route"},resolvedPagePath:"C:\\Users\\USER\\Desktop\\BarracudaMareting\\app\\api\\goals\\postback\\route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:f,staticGenerationAsyncStorage:v,serverHooks:_}=g,m="/api/goals/postback/route";function w(){return(0,n.patchFetch)({serverHooks:_,staticGenerationAsyncStorage:v})}},2021:(e,t,a)=>{a.d(t,{BF:()=>l,CL:()=>u,MU:()=>p,ac:()=>g,g:()=>f,vO:()=>c});var s=a(8013);let o=null,i=null,n=process.env.MONGODB_URI||"mongodb://127.0.0.1:27017",r=process.env.DB_NAME||"barracuda";async function c(){if(o&&i)return{client:o,db:i};try{return o=new s.MongoClient(n),await o.connect(),i=o.db(r),console.log("âœ… Connected to MongoDB"),await d(i),{client:o,db:i}}catch(e){throw console.error("âŒ MongoDB connection error:",e),e}}async function d(e){let t=e.collection("contacts");await t.createIndex({email:1}),await t.createIndex({type:1}),await t.createIndex({status:1}),await t.createIndex({affiliate_id:1}),await t.createIndex({createdAt:-1}),await t.createIndex({sub1:1});let a=e.collection("postbacks");await a.createIndex({click_id:1,goal:1},{unique:!0}),await a.createIndex({affiliate_id:1}),await a.createIndex({createdAt:-1});let s=e.collection("ftds");await s.createIndex({click_id:1},{unique:!0}),await s.createIndex({affiliate_id:1}),await s.createIndex({createdAt:-1});let o=e.collection("admins");await o.createIndex({email:1},{unique:!0});let i=e.collection("conversions");await i.createIndex({click_id:1,goal_id:1},{unique:!0}),await i.createIndex({affiliate_id:1}),await i.createIndex({goal_type:1}),await i.createIndex({createdAt:-1}),console.log("âœ… Database indexes created")}function u(e){return e.collection("contacts")}function l(e){return e.collection("postbacks")}function p(e){return e.collection("ftds")}function g(e){return e.collection("admins")}function f(e){return e.collection("conversions")}}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),s=t.X(0,[276,972],()=>a(8362));module.exports=s})();